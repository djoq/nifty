{"ast":null,"code":"import { load as _load, mapToCanvas, createImage } from './image';\nimport { dataUrl as mapToDataUrl } from './canvas';\nimport { blob as mapToBlob } from './blob';\nimport * as style from './style';\nimport { clone, extend } from './object';\nimport pool from './canvas/pool';\n/**\n * A configuration type for the watermark function\n *\n * @typedef {Object} Options\n * @property {Function} init - an initialization function that is given Image objects before loading (only applies if resources is a collection of urls)\n * @property {ImageFormat} type - specify the image format to be used when retrieving result (only supports \"image/png\" or \"image/jpeg\", default \"image/png\")\n * @property {Number} encoderOptions - specify the image compression quality from 0 to 1 (default 0.92)\n * @property {Number} poolSize - number of canvas elements available for drawing,\n * @property {CanvasPool} pool - the pool used. If provided, poolSize will be ignored\n */\n\n/**\n * @constant\n * @type {Options}\n */\n\nvar defaults = {\n  init: function init() {},\n  type: 'image/png',\n  encoderOptions: 0.92\n};\n/**\n * Merge the given options with the defaults\n *\n * @param {Options} options\n * @return {Options}\n */\n\nfunction mergeOptions(options) {\n  return extend(clone(defaults), options);\n}\n/**\n * Release canvases from a draw result for reuse. Returns\n * the dataURL from the result's canvas\n *\n * @param {DrawResult} result\n * @param {CanvasPool} pool\n * @return  {String}\n */\n\n\nfunction release(result, pool, parameters) {\n  var canvas = result.canvas,\n      sources = result.sources;\n  var dataURL = mapToDataUrl(canvas, parameters);\n  sources.forEach(pool.release);\n  return dataURL;\n}\n/**\n * Return a watermark object\n *\n *\n * @param {Array} resources - a collection of urls, File objects, or Image objects\n * @param {Options} options - a configuration object for watermark\n * @param {Promise} promise - optional\n * @return {Object}\n */\n\n\nexport default function watermark(resources) {\n  var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n  var promise = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : null;\n  var opts = mergeOptions(options);\n  promise || (promise = _load(resources, opts.init));\n  return {\n    /**\n     * Convert the watermarked image into a dataUrl. The draw\n     * function is given all images as canvas elements in order\n     *\n     * @param {Function} draw\n     * @return {Object}\n     */\n    dataUrl: function dataUrl(draw) {\n      var promise = this.then(function (images) {\n        return mapToCanvas(images, pool);\n      }).then(function (canvases) {\n        return style.result(draw, canvases);\n      }).then(function (result) {\n        return release(result, pool, {\n          type: opts.type,\n          encoderOptions: opts.encoderOptions\n        });\n      });\n      return watermark(resources, opts, promise);\n    },\n\n    /**\n     * Load additional resources\n     *\n     * @param {Array} resources - a collection of urls, File objects, or Image objects\n     * @param {Function} init - an initialization function that is given Image objects before loading (only applies if resources is a collection of urls)\n     * @return {Object}\n     */\n    load: function load(resources, init) {\n      var promise = this.then(function (resource) {\n        return _load([resource].concat(resources), init);\n      });\n      return watermark(resources, opts, promise);\n    },\n\n    /**\n     * Render the current state of the watermarked image. Useful for performing\n     * actions after the watermark has been applied\n     *\n     * @return {Object}\n     */\n    render: function render() {\n      var promise = this.then(function (resource) {\n        return _load([resource]);\n      });\n      return watermark(resources, opts, promise);\n    },\n\n    /**\n     * Convert the watermark into a blob\n     *\n     * @param {Function} draw\n     * @return {Object}\n     */\n    blob: function blob(draw) {\n      var promise = this.dataUrl(draw).then(mapToBlob);\n      return watermark(resources, opts, promise);\n    },\n\n    /**\n     * Convert the watermark into an image using the given draw function\n     *\n     * @param {Function} draw\n     * @return {Object}\n     */\n    image: function image(draw) {\n      var promise = this.dataUrl(draw).then(createImage);\n      return watermark(resources, opts, promise);\n    },\n\n    /**\n     * Delegate to the watermark promise\n     *\n     * @return {Promise}\n     */\n    then: function then() {\n      for (var _len = arguments.length, funcs = new Array(_len), _key = 0; _key < _len; _key++) {\n        funcs[_key] = arguments[_key];\n      }\n\n      return promise.then.apply(promise, funcs);\n    }\n  };\n}\n;\n/**\n * Style functions\n */\n\nwatermark.image = style.image;\nwatermark.text = style.text;\n/**\n * Clean up all canvas references\n */\n\nwatermark.destroy = function () {\n  return pool.clear();\n};","map":{"version":3,"sources":["/home/danny/apps/sandbox/nifty/node_modules/watermarkjs/lib/index.js"],"names":["load","mapToCanvas","createImage","dataUrl","mapToDataUrl","blob","mapToBlob","style","clone","extend","pool","defaults","init","type","encoderOptions","mergeOptions","options","release","result","parameters","canvas","sources","dataURL","forEach","watermark","resources","promise","opts","draw","then","images","canvases","resource","concat","render","image","funcs","apply","text","destroy","clear"],"mappings":"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","sourcesContent":["import {load, mapToCanvas, createImage} from './image';\nimport {dataUrl as mapToDataUrl} from './canvas';\nimport {blob as mapToBlob} from './blob';\nimport * as style from './style';\nimport {clone, extend} from './object';\nimport pool from './canvas/pool';\n\n/**\n * A configuration type for the watermark function\n *\n * @typedef {Object} Options\n * @property {Function} init - an initialization function that is given Image objects before loading (only applies if resources is a collection of urls)\n * @property {ImageFormat} type - specify the image format to be used when retrieving result (only supports \"image/png\" or \"image/jpeg\", default \"image/png\")\n * @property {Number} encoderOptions - specify the image compression quality from 0 to 1 (default 0.92)\n * @property {Number} poolSize - number of canvas elements available for drawing,\n * @property {CanvasPool} pool - the pool used. If provided, poolSize will be ignored\n */\n\n/**\n * @constant\n * @type {Options}\n */\nconst defaults = {\n  init: () => {},\n  type: 'image/png',\n  encoderOptions: 0.92\n}\n\n/**\n * Merge the given options with the defaults\n *\n * @param {Options} options\n * @return {Options}\n */\nfunction mergeOptions(options) {\n  return extend(clone(defaults), options);\n}\n\n/**\n * Release canvases from a draw result for reuse. Returns\n * the dataURL from the result's canvas\n *\n * @param {DrawResult} result\n * @param {CanvasPool} pool\n * @return  {String}\n */\nfunction release(result, pool, parameters) {\n  const { canvas, sources } = result;\n  const dataURL = mapToDataUrl(canvas, parameters);\n  sources.forEach(pool.release);\n  return dataURL;\n}\n\n/**\n * Return a watermark object\n *\n *\n * @param {Array} resources - a collection of urls, File objects, or Image objects\n * @param {Options} options - a configuration object for watermark\n * @param {Promise} promise - optional\n * @return {Object}\n */\nexport default function watermark(resources, options = {}, promise = null) {\n  const opts = mergeOptions(options);\n  promise || (promise = load(resources, opts.init));\n\n  return {\n    /**\n     * Convert the watermarked image into a dataUrl. The draw\n     * function is given all images as canvas elements in order\n     *\n     * @param {Function} draw\n     * @return {Object}\n     */\n    dataUrl(draw) {\n      const promise = this\n        .then(images => mapToCanvas(images, pool))\n        .then(canvases => style.result(draw, canvases))\n        .then(result => release(result, pool, { type: opts.type, encoderOptions:opts.encoderOptions }));\n\n      return watermark(resources, opts, promise);\n    },\n\n    /**\n     * Load additional resources\n     *\n     * @param {Array} resources - a collection of urls, File objects, or Image objects\n     * @param {Function} init - an initialization function that is given Image objects before loading (only applies if resources is a collection of urls)\n     * @return {Object}\n     */\n    load(resources, init) {\n      const promise = this\n        .then(resource => load([resource].concat(resources), init));\n\n      return watermark(resources, opts, promise);\n    },\n\n    /**\n     * Render the current state of the watermarked image. Useful for performing\n     * actions after the watermark has been applied\n     *\n     * @return {Object}\n     */\n    render() {\n      const promise = this\n        .then(resource => load([resource]));\n\n      return watermark(resources, opts, promise);\n    },\n\n    /**\n     * Convert the watermark into a blob\n     *\n     * @param {Function} draw\n     * @return {Object}\n     */\n    blob(draw) {\n      const promise = this.dataUrl(draw)\n        .then(mapToBlob);\n\n      return watermark(resources, opts, promise);\n    },\n\n    /**\n     * Convert the watermark into an image using the given draw function\n     *\n     * @param {Function} draw\n     * @return {Object}\n     */\n    image(draw) {\n      const promise = this.dataUrl(draw)\n        .then(createImage);\n\n      return watermark(resources, opts, promise);\n    },\n\n    /**\n     * Delegate to the watermark promise\n     *\n     * @return {Promise}\n     */\n    then(...funcs) {\n      return promise.then.apply(promise, funcs);\n    }\n  };\n};\n\n/**\n * Style functions\n */\nwatermark.image = style.image;\nwatermark.text = style.text;\n\n/**\n * Clean up all canvas references\n */\nwatermark.destroy = () => pool.clear();\n"]},"metadata":{},"sourceType":"module"}